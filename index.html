<!DOCTYPE html>
<html>
  <head>
    <script src="src/index.js"></script>
    <script>
      window.addEventListener("load", function () {
        var mapData;
        var collectionData;
        document.querySelector("#osudb").addEventListener("change", (input) => {
          console.log(input);
          let file = document.querySelector("#osudb").files[0];

          let reader = new FileReader();

          reader.readAsArrayBuffer(file);

          reader.onload = function () {
            buffer = reader.result;
            mapData = new OsuDB(buffer);
            if (collectionData && mapData) {
              parseCollections();
            }
          };

          reader.onerror = function () {
            console.log(reader.error);
          };
        });
        document
          .querySelector("#collectiondb")
          .addEventListener("change", (input) => {
            let file = document.querySelector("#collectiondb").files[0];

            let reader = new FileReader();

            reader.readAsArrayBuffer(file);

            reader.onload = function () {
              buffer = reader.result;
              collectionData = new CollectionDB(buffer);
              if (collectionData && mapData) {
                parseCollections();
              }
            };

            reader.onerror = function () {
              console.log(reader.error);
            };
          });
        function parseCollections() {
          maps = mapData.readBeatmaps();
          collections = collectionData.readCollections();
          collectionString = "";
          for (var i = 0; i < collections.collections.length; i++) {
            // console.log(collections.collections[i].name);
            collectionString += collections.collections[i].name + "\n";
            for (var j = 0; j < collections.collections[i].hashes.length; j++) {
              if (collections.collections[i].hashes[j] in maps) {
                var map = maps[collections.collections[i].hashes[j]];
                // console.log(map.song_title + ": " + map.difficulty);
                // console.log(collections.collections[i].hashes[j])
                var url = `https://osu.ppy.sh/beatmaps/${map.beatmap_id}`
                collectionString += `${map.song_title}: ${map.difficulty}: ${url}\n`;
              }
            }
            // console.log("\n");
            collectionString += "\n";
          }
          document.querySelector("#paragraph").value = collectionString;
        }
      });
    </script>
  </head>
  <body>
    <h1>osu! Collection Exporter</h1>
    <h2>Step 1: Upload your osu!.db file</h2>
    <input id="osudb" type="file" />
    <h2>Step 2: Upload your collection.db file</h2>
    <input id="collectiondb" type="file" />
    <br>
    <br>
    NOTE: This entire process is performed locally on your browser and nothing is ever uploaded to our servers
    <br>
    <textarea id="paragraph" rows="60" cols="100"></textarea>
  </body>
</html>
